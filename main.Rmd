---
title: "main"
output: html_document
date: "2022-11-20"
author: "Jonas Barth, Mattia Castaldo, Matteo Migliarino"
---

```{r}
install.packages('VGAM')
library('VGAM')
```

## Hyperparameters
```{r}
n = 100
eps = 0.1
m = n^(1 / (2 + 1))
```



## Original Histogram
```{r}
b_sample = rbeta(n=n, 10, 10)

original_hist = hist(b_sample, plot=F, breaks=m-1, prob=T)

plot(original_hist)
```


## Create Perturbed Histogram
```{r}

l_perturbe = function(h, l_mean = 0, l_scale = 8 / (0.01 ^ 2)) {
    perturbed_hist = h
    lap_sample = rlaplace(length(perturbed_hist$counts), location = l_mean, scale = l_scale)
    
    # Add the laplace sample to D_j
    perturbed_hist$counts = perturbed_hist$counts + lap_sample
    
    # If we end up with a negative number, we choose 0 instead. Same as max(0, D_j)
    perturbed_hist$counts[perturbed_hist$counts <= 0] = 0

    # Normalise D_j over the sum of all bins
    perturbed_hist$counts = perturbed_hist$counts / sum(perturbed_hist$counts)
    
    # Also update the density
    perturbed_hist$density = perturbed_hist$counts / sum(perturbed_hist$counts)
    
    return(perturbed_hist)
}


perturbed_hist = l_perturbe(original_hist, l_scale = 8 / (eps^2))
plot(perturbed_hist)
```

## Density Function for histogram
```{r}
d_hist = function(x, h) {
    densities = vector(length = length(x))
    for (i in 1:length(x)) {
        val = x[i]
        
        if (val < min(h$breaks) || val > max(h$breaks)) 
            densities[i] = 0
    
        for(j in 1:(length(h$breaks)-1)){
            if (val > h$breaks[j] && val <= h$breaks[j+1])
                densities[i] = h$density[j]
        }
    }
    return(densities)
}
```

## MISE between the true model and the original histogram
```{r}
mise_original = integrate(function(x) (dbeta(x, 10, 10) - d_hist(x, original_hist))^2, 0, 1)
```

## MISE between the true model and the privatized histogram
$$\mathbb{E}_{P_X, Q}(r(Z_1,...,Z_k)) = \int \left( \int r(z_1,...,z_k)dQ(z_1,...,z_k | x_1,...,x_k) \right )dP_X(x_1)...dP_X(x_n)$$
```{r}
mise_perturbed = integrate(function(x) (dbeta(x, 10, 10) - d_hist(x, perturbed_hist))^2, 0, 1)
```


## Figure out dQ in the integral
$$dQ(z_1,...,z_k | x_1,...,x_k)$$
```{r}
# for each sample in b_sample, find the bin it falls into in the perturbed histogram and get the density of that bin.
dQ = vector(length = length(b_sample))

for (i in 1:length(b_sample)) {
    dQ[i] = b_sample[i] * d_hist(b_sample[i], perturbed_hist)
}

```

## Create a function that integrates the inner integral
$$\int r(z_1,...,z_k)dQ(z_1,...,z_k | x_1,...,x_k)$$
```{r}
inner = function(x) {
    integrate(function(x) ((dbeta(x, 10, 10) - d_hist(x, perturbed_hist))^2) * dQ, 0, 1)
}
```

## Integrate the entire function
```{r}
integrate(function(x) (inner(x) * dbeta(x, 10, 10)), 0, 1)
```


