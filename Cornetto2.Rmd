---
title: "Wasserschtein Distance"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---
I first initialize an LCG and sample at random $N=1000$ samples, then I use a Quantile Exponential transformation to obtain a new population
```{r}
f <- function(x, a=12345, b=690690690, M=2^32) {
    return ((a+ b * x) %% M)
}
lcg <- function(N, seed=13, a=104729, b=179424673, M=29996224275833, normalize=FALSE){
  li = c(f(seed, a, b, M))
  for (i in 2:N) {
    li = append(li, f(li[i-1], a, b, M))
  }
  if (normalize) 
    return(li/(M+1))
  else
    return(li)
}
y_samp = qexp(lcg(1000, normalize = TRUE))
hist(y_samp)
```
An this is the $Exp$ distribution that I'm trying to simulate
```{r}
curve(dexp, -0.5,7, lwd = 3,
      col = 'orange',
      xlab = 'x',
      ylab = expression(f[x])
      )
grid()
```

Now I write some utility functions that will be handy for later. In particular one that converts an histogram to the **Cumulative** version of itself, and one that converts an histogram to the **Quantile** version of itself
```{r}
hist_to_cumulative <- function(h) {
  cdf = 1:length(h$density)
  for (i in 1:length(h$density)) {
    cdf[i] = sum(unlist(h$density)[1:i])
    # each element is the sum of the previous ones
  }
  h$density = list(cdf/cdf[length(cdf)]) #normalized
  return(h)
}
```
`Hist_to_quantile` approximates an histogram with a function, which will be $Q(p)$, we plot our approximation:
```{r}
hist_to_quantile_func <- function(h) {
  h = hist_to_cumulative(h)
  # Returns Q(p)
  return( function(p) {
    r = 1:length(p)
    for (i in 1:length(p)) {
      bin = suppressWarnings( # R gives me an error when bin=-Inf, but this is intended
        max(which(unlist(h$density) <= p[i])))
      if (bin == -Inf) {
        r[i] = 0
      }
      else {
        r[i] = h$breaks[bin]
      }
    }
    return(r)
  })
}

f = hist_to_quantile_func(hist(y_samp,30, plot=FALSE))

curve(f, 0,1, lwd = 3,
      col = 'orange',
      xlab = 'x',
      ylab = expression(Approx_Q[x])
      )
grid()
```

Finally we can compute the Wasserschein distance
$$
Wasserschein_{unidimensional} = \int | F^{-1}_X(x) - F^{-1}_Y(x)|dx
$$
```{r}
Wass <- function(f_true, y_samp, nbins=10) {
  q = hist_to_quantile_func(hist(y_samp,nbins, plot = FALSE))
  
  D <- function(x) {abs(f_true(x) - q(x))}
  res = integrate(D,lower = 0,upper = 1, subdivisions = 2000)
  return (c(res$value, res$abs.error))
}

Wass(qexp, y_samp, 10)
Wass(qexp, y_samp, 100)
Wass(qexp, y_samp, 1000)
```
We note that by increasing the resolution of the histogram we obtain less error

